
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "beginner/blitz/autograd_tutorial.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        Click :ref:`here <sphx_glr_download_beginner_blitz_autograd_tutorial.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_beginner_blitz_autograd_tutorial.py:


A Gentle Introduction to ``torch.autograd``
---------------------------------

``torch.autograd`` is PyTorch’s automatic differentiation engine that powers
neural network training. In this section, you will get a conceptual
understanding of how autograd helps a neural network train.

Background
~~~~~~~~~~
Neural networks (NNs) are a collection of nested functions that are
executed on some input data. These functions are defined by *parameters*
(consisting of weights and biases), which in PyTorch are stored in
tensors.

Training a NN happens in two steps:

**Forward Propagation**: In forward prop, the NN makes its best guess
about the correct output. It runs the input data through each of its
functions to make this guess.

**Backward Propagation**: In backprop, the NN adjusts its parameters
proportionate to the error in its guess. It does this by traversing
backwards from the output, collecting the derivatives of the error with
respect to the parameters of the functions (*gradients*), and optimizing
the parameters using gradient descent. For a more detailed walkthrough
of backprop, check out this `video from
3Blue1Brown <https://www.youtube.com/watch?v=tIeHLnjs5U8>`__.




Usage in PyTorch
~~~~~~~~~~~~~~~~
Let's take a look at a single training step.
For this example, we load a pretrained resnet18 model from ``torchvision``.
We create a random data tensor to represent a single image with 3 channels, and height & width of 64,
and its corresponding ``label`` initialized to some random values. Label in pretrained models has
shape (1,1000).

.. note::
    This tutorial work only on CPU and will not work on GPU (even if tensor are moved to CUDA).

.. GENERATED FROM PYTHON SOURCE LINES 46-52

.. code-block:: default

    import torch
    from torchvision.models import resnet18, ResNet18_Weights
    model = resnet18(weights=ResNet18_Weights.DEFAULT)
    data = torch.rand(1, 3, 64, 64)
    labels = torch.rand(1, 1000)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Downloading: "https://download.pytorch.org/models/resnet18-f37072fd.pth" to /var/lib/jenkins/.cache/torch/hub/checkpoints/resnet18-f37072fd.pth

      0%|          | 0.00/44.7M [00:00<?, ?B/s]
      0%|          | 208k/44.7M [00:00<00:24, 1.92MB/s]
      1%|1         | 528k/44.7M [00:00<00:18, 2.56MB/s]
      2%|1         | 800k/44.7M [00:00<00:17, 2.62MB/s]
      2%|2         | 1.04M/44.7M [00:00<00:17, 2.64MB/s]
      3%|2         | 1.30M/44.7M [00:00<00:17, 2.65MB/s]
      4%|3         | 1.58M/44.7M [00:00<00:16, 2.71MB/s]
      4%|4         | 1.88M/44.7M [00:00<00:16, 2.78MB/s]
      5%|4         | 2.17M/44.7M [00:00<00:15, 2.85MB/s]
      6%|5         | 2.47M/44.7M [00:00<00:15, 2.90MB/s]
      6%|6         | 2.77M/44.7M [00:01<00:14, 2.94MB/s]
      7%|6         | 3.06M/44.7M [00:01<00:14, 2.98MB/s]
      8%|7         | 3.38M/44.7M [00:01<00:14, 3.05MB/s]
      8%|8         | 3.69M/44.7M [00:01<00:13, 3.12MB/s]
      9%|8         | 4.00M/44.7M [00:01<00:13, 3.15MB/s]
     10%|9         | 4.31M/44.7M [00:01<00:13, 3.17MB/s]
     10%|#         | 4.64M/44.7M [00:01<00:12, 3.23MB/s]
     11%|#1        | 4.97M/44.7M [00:01<00:12, 3.28MB/s]
     12%|#1        | 5.30M/44.7M [00:01<00:12, 3.31MB/s]
     13%|#2        | 5.62M/44.7M [00:01<00:12, 3.34MB/s]
     13%|#3        | 5.97M/44.7M [00:02<00:11, 3.40MB/s]
     14%|#4        | 6.31M/44.7M [00:02<00:11, 3.44MB/s]
     15%|#4        | 6.66M/44.7M [00:02<00:11, 3.48MB/s]
     16%|#5        | 7.00M/44.7M [00:02<00:11, 3.51MB/s]
     16%|#6        | 7.36M/44.7M [00:02<00:10, 3.57MB/s]
     17%|#7        | 7.73M/44.7M [00:02<00:10, 3.62MB/s]
     18%|#8        | 8.11M/44.7M [00:02<00:10, 3.70MB/s]
     19%|#8        | 8.47M/44.7M [00:02<00:11, 3.35MB/s]
     20%|#9        | 8.80M/44.7M [00:02<00:11, 3.36MB/s]
     20%|##        | 9.12M/44.7M [00:03<00:11, 3.16MB/s]
     21%|##1       | 9.44M/44.7M [00:03<00:11, 3.10MB/s]
     22%|##1       | 9.74M/44.7M [00:03<00:11, 3.10MB/s]
     22%|##2       | 10.0M/44.7M [00:03<00:11, 3.11MB/s]
     23%|##3       | 10.4M/44.7M [00:03<00:12, 2.94MB/s]
     24%|##3       | 10.6M/44.7M [00:03<00:12, 2.82MB/s]
     24%|##4       | 10.9M/44.7M [00:03<00:15, 2.35MB/s]
     25%|##4       | 11.2M/44.7M [00:03<00:16, 2.12MB/s]
     25%|##5       | 11.4M/44.7M [00:04<00:17, 2.01MB/s]
     26%|##5       | 11.6M/44.7M [00:04<00:17, 1.96MB/s]
     26%|##6       | 11.8M/44.7M [00:04<00:17, 1.97MB/s]
     27%|##6       | 12.0M/44.7M [00:04<00:17, 1.95MB/s]
     27%|##7       | 12.2M/44.7M [00:04<00:17, 1.97MB/s]
     28%|##7       | 12.4M/44.7M [00:04<00:17, 1.98MB/s]
     28%|##8       | 12.6M/44.7M [00:04<00:16, 2.01MB/s]
     29%|##8       | 12.8M/44.7M [00:04<00:16, 2.06MB/s]
     29%|##9       | 13.0M/44.7M [00:04<00:15, 2.13MB/s]
     30%|##9       | 13.2M/44.7M [00:05<00:15, 2.16MB/s]
     30%|###       | 13.5M/44.7M [00:05<00:14, 2.22MB/s]
     31%|###       | 13.7M/44.7M [00:05<00:14, 2.26MB/s]
     31%|###1      | 13.9M/44.7M [00:05<00:13, 2.32MB/s]
     32%|###1      | 14.2M/44.7M [00:05<00:13, 2.39MB/s]
     32%|###2      | 14.4M/44.7M [00:05<00:12, 2.45MB/s]
     33%|###2      | 14.7M/44.7M [00:05<00:12, 2.49MB/s]
     33%|###3      | 14.9M/44.7M [00:05<00:12, 2.53MB/s]
     34%|###4      | 15.2M/44.7M [00:05<00:11, 2.63MB/s]
     35%|###4      | 15.5M/44.7M [00:05<00:11, 2.67MB/s]
     35%|###5      | 15.8M/44.7M [00:06<00:11, 2.72MB/s]
     36%|###5      | 16.0M/44.7M [00:06<00:10, 2.77MB/s]
     37%|###6      | 16.3M/44.7M [00:06<00:10, 2.82MB/s]
     37%|###7      | 16.7M/44.7M [00:06<00:10, 2.88MB/s]
     38%|###7      | 16.9M/44.7M [00:06<00:10, 2.80MB/s]
     39%|###8      | 17.2M/44.7M [00:06<00:10, 2.65MB/s]
     39%|###9      | 17.5M/44.7M [00:06<00:11, 2.51MB/s]
     40%|###9      | 17.7M/44.7M [00:06<00:11, 2.50MB/s]
     40%|####      | 18.0M/44.7M [00:06<00:11, 2.48MB/s]
     41%|####      | 18.2M/44.7M [00:07<00:11, 2.48MB/s]
     41%|####1     | 18.5M/44.7M [00:07<00:10, 2.51MB/s]
     42%|####1     | 18.7M/44.7M [00:07<00:10, 2.52MB/s]
     42%|####2     | 19.0M/44.7M [00:07<00:10, 2.56MB/s]
     43%|####3     | 19.2M/44.7M [00:07<00:10, 2.60MB/s]
     44%|####3     | 19.5M/44.7M [00:07<00:09, 2.67MB/s]
     44%|####4     | 19.8M/44.7M [00:07<00:09, 2.70MB/s]
     45%|####4     | 20.1M/44.7M [00:07<00:09, 2.72MB/s]
     46%|####5     | 20.3M/44.7M [00:07<00:09, 2.74MB/s]
     46%|####6     | 20.6M/44.7M [00:07<00:09, 2.73MB/s]
     47%|####6     | 20.9M/44.7M [00:08<00:09, 2.50MB/s]
     47%|####7     | 21.1M/44.7M [00:08<00:10, 2.40MB/s]
     48%|####7     | 21.4M/44.7M [00:08<00:10, 2.33MB/s]
     48%|####8     | 21.6M/44.7M [00:08<00:10, 2.34MB/s]
     49%|####8     | 21.8M/44.7M [00:08<00:10, 2.30MB/s]
     49%|####9     | 22.0M/44.7M [00:08<00:10, 2.31MB/s]
     50%|####9     | 22.3M/44.7M [00:08<00:10, 2.32MB/s]
     50%|#####     | 22.5M/44.7M [00:08<00:09, 2.36MB/s]
     51%|#####1    | 22.8M/44.7M [00:08<00:09, 2.42MB/s]
     52%|#####1    | 23.1M/44.7M [00:09<00:09, 2.49MB/s]
     52%|#####2    | 23.3M/44.7M [00:09<00:08, 2.54MB/s]
     53%|#####2    | 23.6M/44.7M [00:09<00:08, 2.57MB/s]
     53%|#####3    | 23.9M/44.7M [00:09<00:08, 2.63MB/s]
     54%|#####4    | 24.1M/44.7M [00:09<00:08, 2.55MB/s]
     55%|#####4    | 24.4M/44.7M [00:09<00:08, 2.38MB/s]
     55%|#####5    | 24.6M/44.7M [00:09<00:09, 2.31MB/s]
     56%|#####5    | 24.8M/44.7M [00:09<00:09, 2.26MB/s]
     56%|#####6    | 25.0M/44.7M [00:09<00:09, 2.25MB/s]
     57%|#####6    | 25.3M/44.7M [00:10<00:09, 2.25MB/s]
     57%|#####7    | 25.5M/44.7M [00:10<00:08, 2.30MB/s]
     58%|#####7    | 25.7M/44.7M [00:10<00:08, 2.33MB/s]
     58%|#####8    | 26.0M/44.7M [00:10<00:08, 2.36MB/s]
     59%|#####8    | 26.2M/44.7M [00:10<00:08, 2.40MB/s]
     59%|#####9    | 26.5M/44.7M [00:10<00:07, 2.43MB/s]
     60%|#####9    | 26.7M/44.7M [00:10<00:07, 2.48MB/s]
     60%|######    | 27.0M/44.7M [00:10<00:07, 2.51MB/s]
     61%|######    | 27.2M/44.7M [00:10<00:07, 2.57MB/s]
     62%|######1   | 27.5M/44.7M [00:10<00:06, 2.62MB/s]
     62%|######2   | 27.8M/44.7M [00:11<00:06, 2.66MB/s]
     63%|######2   | 28.0M/44.7M [00:11<00:06, 2.73MB/s]
     63%|######3   | 28.3M/44.7M [00:11<00:06, 2.52MB/s]
     64%|######3   | 28.6M/44.7M [00:11<00:06, 2.55MB/s]
     65%|######4   | 28.8M/44.7M [00:11<00:06, 2.41MB/s]
     65%|######5   | 29.1M/44.7M [00:11<00:06, 2.35MB/s]
     66%|######5   | 29.3M/44.7M [00:11<00:06, 2.33MB/s]
     66%|######6   | 29.5M/44.7M [00:11<00:06, 2.36MB/s]
     67%|######6   | 29.8M/44.7M [00:11<00:06, 2.37MB/s]
     67%|######7   | 30.0M/44.7M [00:12<00:06, 2.39MB/s]
     68%|######7   | 30.2M/44.7M [00:12<00:06, 2.41MB/s]
     68%|######8   | 30.5M/44.7M [00:12<00:06, 2.46MB/s]
     69%|######8   | 30.7M/44.7M [00:12<00:05, 2.49MB/s]
     69%|######9   | 31.0M/44.7M [00:12<00:05, 2.53MB/s]
     70%|######9   | 31.2M/44.7M [00:12<00:06, 2.31MB/s]
     70%|#######   | 31.5M/44.7M [00:12<00:06, 1.99MB/s]
     71%|#######   | 31.7M/44.7M [00:12<00:07, 1.79MB/s]
     71%|#######1  | 31.8M/44.7M [00:13<00:07, 1.71MB/s]
     72%|#######1  | 32.0M/44.7M [00:13<00:08, 1.66MB/s]
     72%|#######2  | 32.2M/44.7M [00:13<00:08, 1.62MB/s]
     72%|#######2  | 32.3M/44.7M [00:13<00:07, 1.63MB/s]
     73%|#######2  | 32.5M/44.7M [00:13<00:07, 1.67MB/s]
     73%|#######3  | 32.7M/44.7M [00:13<00:07, 1.70MB/s]
     74%|#######3  | 32.9M/44.7M [00:13<00:07, 1.72MB/s]
     74%|#######3  | 33.0M/44.7M [00:13<00:06, 1.77MB/s]
     74%|#######4  | 33.2M/44.7M [00:13<00:06, 1.83MB/s]
     75%|#######4  | 33.5M/44.7M [00:13<00:06, 1.90MB/s]
     75%|#######5  | 33.7M/44.7M [00:14<00:05, 1.94MB/s]
     76%|#######5  | 33.9M/44.7M [00:14<00:05, 1.98MB/s]
     76%|#######6  | 34.1M/44.7M [00:14<00:05, 1.96MB/s]
     77%|#######6  | 34.2M/44.7M [00:14<00:05, 1.90MB/s]
     77%|#######7  | 34.4M/44.7M [00:14<00:05, 1.81MB/s]
     77%|#######7  | 34.6M/44.7M [00:14<00:06, 1.75MB/s]
     78%|#######7  | 34.8M/44.7M [00:14<00:05, 1.74MB/s]
     78%|#######8  | 35.0M/44.7M [00:14<00:05, 1.74MB/s]
     79%|#######8  | 35.1M/44.7M [00:14<00:05, 1.76MB/s]
     79%|#######9  | 35.3M/44.7M [00:15<00:05, 1.80MB/s]
     80%|#######9  | 35.5M/44.7M [00:15<00:05, 1.81MB/s]
     80%|#######9  | 35.7M/44.7M [00:15<00:05, 1.87MB/s]
     80%|########  | 35.9M/44.7M [00:15<00:04, 1.92MB/s]
     81%|########  | 36.1M/44.7M [00:15<00:04, 1.96MB/s]
     81%|########1 | 36.3M/44.7M [00:15<00:04, 2.03MB/s]
     82%|########1 | 36.6M/44.7M [00:15<00:04, 2.07MB/s]
     82%|########2 | 36.8M/44.7M [00:15<00:03, 2.12MB/s]
     83%|########2 | 37.0M/44.7M [00:15<00:03, 2.18MB/s]
     83%|########3 | 37.2M/44.7M [00:16<00:03, 2.19MB/s]
     84%|########3 | 37.5M/44.7M [00:16<00:03, 2.04MB/s]
     84%|########4 | 37.7M/44.7M [00:16<00:03, 1.97MB/s]
     85%|########4 | 37.9M/44.7M [00:16<00:03, 1.90MB/s]
     85%|########5 | 38.0M/44.7M [00:16<00:03, 1.90MB/s]
     86%|########5 | 38.2M/44.7M [00:16<00:03, 1.91MB/s]
     86%|########6 | 38.4M/44.7M [00:16<00:03, 1.92MB/s]
     86%|########6 | 38.6M/44.7M [00:16<00:03, 1.97MB/s]
     87%|########6 | 38.8M/44.7M [00:16<00:03, 2.00MB/s]
     87%|########7 | 39.0M/44.7M [00:16<00:02, 2.03MB/s]
     88%|########7 | 39.2M/44.7M [00:17<00:02, 2.07MB/s]
     88%|########8 | 39.5M/44.7M [00:17<00:02, 2.12MB/s]
     89%|########8 | 39.7M/44.7M [00:17<00:02, 2.20MB/s]
     89%|########9 | 39.9M/44.7M [00:17<00:02, 2.23MB/s]
     90%|########9 | 40.2M/44.7M [00:17<00:02, 2.28MB/s]
     90%|######### | 40.4M/44.7M [00:17<00:01, 2.32MB/s]
     91%|#########1| 40.7M/44.7M [00:17<00:01, 2.38MB/s]
     92%|#########1| 40.9M/44.7M [00:17<00:01, 2.44MB/s]
     92%|#########2| 41.2M/44.7M [00:17<00:01, 2.53MB/s]
     93%|#########2| 41.5M/44.7M [00:18<00:01, 2.58MB/s]
     93%|#########3| 41.7M/44.7M [00:18<00:01, 2.62MB/s]
     94%|#########4| 42.0M/44.7M [00:18<00:01, 2.66MB/s]
     95%|#########4| 42.3M/44.7M [00:18<00:00, 2.73MB/s]
     95%|#########5| 42.6M/44.7M [00:18<00:00, 2.82MB/s]
     96%|#########5| 42.9M/44.7M [00:18<00:00, 2.85MB/s]
     97%|#########6| 43.2M/44.7M [00:18<00:00, 2.90MB/s]
     97%|#########7| 43.5M/44.7M [00:18<00:00, 2.94MB/s]
     98%|#########7| 43.8M/44.7M [00:18<00:00, 3.00MB/s]
     99%|#########8| 44.1M/44.7M [00:18<00:00, 3.10MB/s]
     99%|#########9| 44.4M/44.7M [00:19<00:00, 3.13MB/s]
    100%|##########| 44.7M/44.7M [00:19<00:00, 2.45MB/s]




.. GENERATED FROM PYTHON SOURCE LINES 53-56

Next, we run the input data through the model through each of its layers to make a prediction.
This is the **forward pass**.


.. GENERATED FROM PYTHON SOURCE LINES 56-59

.. code-block:: default


    prediction = model(data) # forward pass








.. GENERATED FROM PYTHON SOURCE LINES 60-65

We use the model's prediction and the corresponding label to calculate the error (``loss``).
The next step is to backpropagate this error through the network.
Backward propagation is kicked off when we call ``.backward()`` on the error tensor.
Autograd then calculates and stores the gradients for each model parameter in the parameter's ``.grad`` attribute.


.. GENERATED FROM PYTHON SOURCE LINES 65-69

.. code-block:: default


    loss = (prediction - labels).sum()
    loss.backward() # backward pass








.. GENERATED FROM PYTHON SOURCE LINES 70-73

Next, we load an optimizer, in this case SGD with a learning rate of 0.01 and `momentum <https://towardsdatascience.com/stochastic-gradient-descent-with-momentum-a84097641a5d>`__ of 0.9.
We register all the parameters of the model in the optimizer.


.. GENERATED FROM PYTHON SOURCE LINES 73-76

.. code-block:: default


    optim = torch.optim.SGD(model.parameters(), lr=1e-2, momentum=0.9)








.. GENERATED FROM PYTHON SOURCE LINES 77-79

Finally, we call ``.step()`` to initiate gradient descent. The optimizer adjusts each parameter by its gradient stored in ``.grad``.


.. GENERATED FROM PYTHON SOURCE LINES 79-82

.. code-block:: default


    optim.step() #gradient descent








.. GENERATED FROM PYTHON SOURCE LINES 83-86

At this point, you have everything you need to train your neural network.
The below sections detail the workings of autograd - feel free to skip them.


.. GENERATED FROM PYTHON SOURCE LINES 89-91

--------------


.. GENERATED FROM PYTHON SOURCE LINES 94-99

Differentiation in Autograd
~~~~~~~~~~~~~~~~~~~~~~~~~~~
Let's take a look at how ``autograd`` collects gradients. We create two tensors ``a`` and ``b`` with
``requires_grad=True``. This signals to ``autograd`` that every operation on them should be tracked.


.. GENERATED FROM PYTHON SOURCE LINES 99-105

.. code-block:: default


    import torch

    a = torch.tensor([2., 3.], requires_grad=True)
    b = torch.tensor([6., 4.], requires_grad=True)








.. GENERATED FROM PYTHON SOURCE LINES 106-110

We create another tensor ``Q`` from ``a`` and ``b``.

.. math::
   Q = 3a^3 - b^2

.. GENERATED FROM PYTHON SOURCE LINES 110-114

.. code-block:: default


    Q = 3*a**3 - b**2









.. GENERATED FROM PYTHON SOURCE LINES 115-138

Let's assume ``a`` and ``b`` to be parameters of an NN, and ``Q``
to be the error. In NN training, we want gradients of the error
w.r.t. parameters, i.e.

.. math::
   \frac{\partial Q}{\partial a} = 9a^2

.. math::
   \frac{\partial Q}{\partial b} = -2b


When we call ``.backward()`` on ``Q``, autograd calculates these gradients
and stores them in the respective tensors' ``.grad`` attribute.

We need to explicitly pass a ``gradient`` argument in ``Q.backward()`` because it is a vector.
``gradient`` is a tensor of the same shape as ``Q``, and it represents the
gradient of Q w.r.t. itself, i.e.

.. math::
   \frac{dQ}{dQ} = 1

Equivalently, we can also aggregate Q into a scalar and call backward implicitly, like ``Q.sum().backward()``.


.. GENERATED FROM PYTHON SOURCE LINES 138-142

.. code-block:: default

    external_grad = torch.tensor([1., 1.])
    Q.backward(gradient=external_grad)









.. GENERATED FROM PYTHON SOURCE LINES 143-144

Gradients are now deposited in ``a.grad`` and ``b.grad``

.. GENERATED FROM PYTHON SOURCE LINES 144-150

.. code-block:: default


    # check if collected gradients are correct
    print(9*a**2 == a.grad)
    print(-2*b == b.grad)






.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    tensor([True, True])
    tensor([True, True])




.. GENERATED FROM PYTHON SOURCE LINES 151-211

Optional Reading - Vector Calculus using ``autograd``
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Mathematically, if you have a vector valued function
:math:`\vec{y}=f(\vec{x})`, then the gradient of :math:`\vec{y}` with
respect to :math:`\vec{x}` is a Jacobian matrix :math:`J`:

.. math::


     J
     =
      \left(\begin{array}{cc}
      \frac{\partial \bf{y}}{\partial x_{1}} &
      ... &
      \frac{\partial \bf{y}}{\partial x_{n}}
      \end{array}\right)
     =
     \left(\begin{array}{ccc}
      \frac{\partial y_{1}}{\partial x_{1}} & \cdots & \frac{\partial y_{1}}{\partial x_{n}}\\
      \vdots & \ddots & \vdots\\
      \frac{\partial y_{m}}{\partial x_{1}} & \cdots & \frac{\partial y_{m}}{\partial x_{n}}
      \end{array}\right)

Generally speaking, ``torch.autograd`` is an engine for computing
vector-Jacobian product. That is, given any vector :math:`\vec{v}`, compute the product
:math:`J^{T}\cdot \vec{v}`

If :math:`\vec{v}` happens to be the gradient of a scalar function :math:`l=g\left(\vec{y}\right)`:

.. math::


  \vec{v}
   =
   \left(\begin{array}{ccc}\frac{\partial l}{\partial y_{1}} & \cdots & \frac{\partial l}{\partial y_{m}}\end{array}\right)^{T}

then by the chain rule, the vector-Jacobian product would be the
gradient of :math:`l` with respect to :math:`\vec{x}`:

.. math::


     J^{T}\cdot \vec{v}=\left(\begin{array}{ccc}
      \frac{\partial y_{1}}{\partial x_{1}} & \cdots & \frac{\partial y_{m}}{\partial x_{1}}\\
      \vdots & \ddots & \vdots\\
      \frac{\partial y_{1}}{\partial x_{n}} & \cdots & \frac{\partial y_{m}}{\partial x_{n}}
      \end{array}\right)\left(\begin{array}{c}
      \frac{\partial l}{\partial y_{1}}\\
      \vdots\\
      \frac{\partial l}{\partial y_{m}}
      \end{array}\right)=\left(\begin{array}{c}
      \frac{\partial l}{\partial x_{1}}\\
      \vdots\\
      \frac{\partial l}{\partial x_{n}}
      \end{array}\right)

This characteristic of vector-Jacobian product is what we use in the above example;
``external_grad`` represents :math:`\vec{v}`.


.. GENERATED FROM PYTHON SOURCE LINES 215-263

Computational Graph
~~~~~~~~~~~~~~~~~~~

Conceptually, autograd keeps a record of data (tensors) & all executed
operations (along with the resulting new tensors) in a directed acyclic
graph (DAG) consisting of
`Function <https://pytorch.org/docs/stable/autograd.html#torch.autograd.Function>`__
objects. In this DAG, leaves are the input tensors, roots are the output
tensors. By tracing this graph from roots to leaves, you can
automatically compute the gradients using the chain rule.

In a forward pass, autograd does two things simultaneously:

- run the requested operation to compute a resulting tensor, and
- maintain the operation’s *gradient function* in the DAG.

The backward pass kicks off when ``.backward()`` is called on the DAG
root. ``autograd`` then:

- computes the gradients from each ``.grad_fn``,
- accumulates them in the respective tensor’s ``.grad`` attribute, and
- using the chain rule, propagates all the way to the leaf tensors.

Below is a visual representation of the DAG in our example. In the graph,
the arrows are in the direction of the forward pass. The nodes represent the backward functions
of each operation in the forward pass. The leaf nodes in blue represent our leaf tensors ``a`` and ``b``.

.. figure:: /_static/img/dag_autograd.png

.. note::
  **DAGs are dynamic in PyTorch**
  An important thing to note is that the graph is recreated from scratch; after each
  ``.backward()`` call, autograd starts populating a new graph. This is
  exactly what allows you to use control flow statements in your model;
  you can change the shape, size and operations at every iteration if
  needed.

Exclusion from the DAG
^^^^^^^^^^^^^^^^^^^^^^

``torch.autograd`` tracks operations on all tensors which have their
``requires_grad`` flag set to ``True``. For tensors that don’t require
gradients, setting this attribute to ``False`` excludes it from the
gradient computation DAG.

The output tensor of an operation will require gradients even if only a
single input tensor has ``requires_grad=True``.


.. GENERATED FROM PYTHON SOURCE LINES 263-274

.. code-block:: default


    x = torch.rand(5, 5)
    y = torch.rand(5, 5)
    z = torch.rand((5, 5), requires_grad=True)

    a = x + y
    print(f"Does `a` require gradients? : {a.requires_grad}")
    b = x + z
    print(f"Does `b` require gradients?: {b.requires_grad}")






.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Does `a` require gradients? : False
    Does `b` require gradients?: True




.. GENERATED FROM PYTHON SOURCE LINES 275-281

In a NN, parameters that don't compute gradients are usually called **frozen parameters**.
It is useful to "freeze" part of your model if you know in advance that you won't need the gradients of those parameters
(this offers some performance benefits by reducing autograd computations).

In finetuning, we freeze most of the model and typically only modify the classifier layers to make predictions on new labels.
Let's walk through a small example to demonstrate this. As before, we load a pretrained resnet18 model, and freeze all the parameters.

.. GENERATED FROM PYTHON SOURCE LINES 281-290

.. code-block:: default


    from torch import nn, optim

    model = resnet18(weights=ResNet18_Weights.DEFAULT)

    # Freeze all the parameters in the network
    for param in model.parameters():
        param.requires_grad = False








.. GENERATED FROM PYTHON SOURCE LINES 291-295

Let's say we want to finetune the model on a new dataset with 10 labels.
In resnet, the classifier is the last linear layer ``model.fc``.
We can simply replace it with a new linear layer (unfrozen by default)
that acts as our classifier.

.. GENERATED FROM PYTHON SOURCE LINES 295-298

.. code-block:: default


    model.fc = nn.Linear(512, 10)








.. GENERATED FROM PYTHON SOURCE LINES 299-301

Now all parameters in the model, except the parameters of ``model.fc``, are frozen.
The only parameters that compute gradients are the weights and bias of ``model.fc``.

.. GENERATED FROM PYTHON SOURCE LINES 301-305

.. code-block:: default


    # Optimize only the classifier
    optimizer = optim.SGD(model.parameters(), lr=1e-2, momentum=0.9)








.. GENERATED FROM PYTHON SOURCE LINES 306-313

Notice although we register all the parameters in the optimizer,
the only parameters that are computing gradients (and hence updated in gradient descent)
are the weights and bias of the classifier.

The same exclusionary functionality is available as a context manager in
`torch.no_grad() <https://pytorch.org/docs/stable/generated/torch.no_grad.html>`__


.. GENERATED FROM PYTHON SOURCE LINES 315-317

--------------


.. GENERATED FROM PYTHON SOURCE LINES 319-324

Further readings:
~~~~~~~~~~~~~~~~~~~

-  `In-place operations & Multithreaded Autograd <https://pytorch.org/docs/stable/notes/autograd.html>`__
-  `Example implementation of reverse-mode autodiff <https://colab.research.google.com/drive/1VpeE6UvEPRz9HmsHh1KS0XxXjYu533EC>`__


.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 0 minutes  19.973 seconds)


.. _sphx_glr_download_beginner_blitz_autograd_tutorial.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example


    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: autograd_tutorial.py <autograd_tutorial.py>`

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: autograd_tutorial.ipynb <autograd_tutorial.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
