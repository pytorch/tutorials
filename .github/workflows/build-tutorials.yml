name: Build tutorials

on:
  pull_request:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}-${{ github.event_name == 'workflow_dispatch' }}-${{ github.event_name == 'schedule' }}
  cancel-in-progress: true

jobs:
  worker:
    name: pytorch_tutorial_build_worker
    strategy:
      matrix:
        include:
          - { shard: 15, num_shards: 15, runner: "linux.4xlarge.nvidia.gpu" }
      fail-fast: false
    runs-on: ${{ matrix.runner }}
    env:
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-focal-cuda12.1-cudnn8-py3-gcc9"
      CUDA_VERSION: "9"
    steps:
      - name: Setup SSH (Click me for login details)
        uses: pytorch/test-infra/.github/actions/setup-ssh@main
        with:
          github-secret: ${{ secrets.GITHUB_TOKEN }}
          instructions: |
            All testing is done inside the container, to start an interactive session run:
              docker exec -it $(docker container ps --format '{{.ID}}') bash

      - name: Checkout Tutorials
        uses: actions/checkout@v3

      - name: Setup Linux
        uses: pytorch/pytorch/.github/actions/setup-linux@main

      - name: Install nvidia driver, nvidia-docker runtime, set GPU_FLAG
        uses: pytorch/test-infra/.github/actions/setup-nvidia@main

      - name: Calculate docker image
        shell: bash
        id: docker-image
        run: |
          set -ex

          # for some reason, pip installs it in a different place than what is looked at in the py file
          pip3 install requests==2.26
          pyTorchDockerImageTag=$(python3 .jenkins/get_docker_tag.py)

          echo "docker-image=${DOCKER_IMAGE}:${pyTorchDockerImageTag}" >> "${GITHUB_OUTPUT}"

      - name: Pull docker image
        uses: pytorch/test-infra/.github/actions/pull-docker-image@main
        with:
          docker-image: pytorch/pytorch/conda-builder:12.1-main

      - name: Build
        shell: bash
        env:
          DOCKER_IMAGE: pytorch/pytorch/conda-builder:12.1-main
          NUM_WORKERS: ${{ matrix.num_shards }}
          WORKER_ID: ${{ matrix.shard }}
          COMMIT_ID: ${{ github.sha }}
          JOB_TYPE: worker
          COMMIT_SOURCE: ${{ github.ref }}
        run: |
          set -ex

          chmod +x ".jenkins/build.sh"

          container_name=$(docker run \
            ${GPU_FLAG:-} \
            -e WORKER_ID \
            -e NUM_WORKERS \
            -e COMMIT_ID \
            -e JOB_TYPE \
            -e COMMIT_SOURCE \
            --env-file="/tmp/github_env_${GITHUB_RUN_ID}" \
            --tty \
            --detach \
            --shm-size=2gb \
            --name="${container_name}" \
            -v "${GITHUB_WORKSPACE}:/var/lib/jenkins/workspace" \
            -u root \
            -w /var/lib/jenkins/workspace \
            "${DOCKER_IMAGE}"
          )

          docker exec -u root -t "${container_name}" sh -c ".jenkins/build.sh"

      - name: Teardown Linux
        uses: pytorch/test-infra/.github/actions/teardown-linux@main
        if: always()

  manager:
    name: pytorch_tutorial_build_manager
    if: false
    needs: worker
    runs-on: [self-hosted, linux.2xlarge]
    environment: ${{ github.ref == 'refs/heads/main' && 'pytorchbot-env' || '' }}
    env:
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-focal-cuda12.1-cudnn8-py3-gcc9"
      CUDA_VERSION: "9"
    steps:
      - name: Setup SSH (Click me for login details)
        uses: pytorch/test-infra/.github/actions/setup-ssh@main
        with:
          github-secret: ${{ secrets.GITHUB_TOKEN }}
          instructions: |
            All testing is done inside the container, to start an interactive session run:
              docker exec -it $(docker container ps --format '{{.ID}}') bash

      - name: Checkout Tutorials
        uses: actions/checkout@v3

      - name: Setup Linux
        uses: pytorch/pytorch/.github/actions/setup-linux@main

      - name: Calculate docker image
        shell: bash
        id: docker-image
        run: |
          set -ex

          # for some reason, pip installs it in a different place than what is looked at in the py file
          pip3 install requests==2.26
          pyTorchDockerImageTag=$(python3 .jenkins/get_docker_tag.py)

          echo "docker-image=${DOCKER_IMAGE}:${pyTorchDockerImageTag}" >> "${GITHUB_OUTPUT}"

      - name: Pull docker image
        uses: pytorch/test-infra/.github/actions/pull-docker-image@main
        with:
          docker-image: pytorch/pytorch

      - name: Build
        shell: bash
        env:
          DOCKER_IMAGE: pytorch/pytorch
          NUM_WORKERS: 15
          WORKER_ID: ${{ matrix.shard }}
          COMMIT_ID: ${{ github.sha }}
          JOB_TYPE: manager
          COMMIT_SOURCE: ${{ github.ref }}
          GITHUB_PYTORCHBOT_TOKEN: ${{ secrets.PYTORCHBOT_TOKEN }}
        run: |
          set -ex

          chmod +x ".jenkins/build.sh"

          container_name=$(docker run \
            ${GPU_FLAG:-} \
            -e WORKER_ID \
            -e NUM_WORKERS \
            -e COMMIT_ID \
            -e JOB_TYPE \
            -e COMMIT_SOURCE \
            -e GITHUB_PYTORCHBOT_TOKEN \
            --env-file="/tmp/github_env_${GITHUB_RUN_ID}" \
            --tty \
            --detach \
            --user jenkins \
            --name="${container_name}" \
            -v "${GITHUB_WORKSPACE}:/var/lib/jenkins/workspace" \
            -w /var/lib/jenkins/workspace \
            "${DOCKER_IMAGE}"
          )

          echo "rm /opt/cache/bin/*" | docker exec -u root -i "${container_name}" bash

          docker exec -t "${container_name}" sh -c ".jenkins/build.sh"

      - name: Upload docs preview
        uses: seemethere/upload-artifact-s3@v5
        if: ${{ github.event_name == 'pull_request' }}
        with:
          retention-days: 14
          s3-bucket: doc-previews
          if-no-files-found: error
          path: docs
          s3-prefix: pytorch/tutorials/${{ github.event.pull_request.number }}

      - name: Teardown Linux
        uses: pytorch/test-infra/.github/actions/teardown-linux@main
        if: always()
